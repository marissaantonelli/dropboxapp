define(["require","exports","tslib","external/classnames","external/react","modules/core/browser","modules/core/exception","modules/core/html","modules/core/notify","modules/core/uri","modules/clean/auth/common/types","modules/clean/auth/login/2fa/authenticator_form","modules/clean/auth/login/2fa/phone_form","modules/clean/auth/login/2fa/seckey_form","modules/clean/auth/login/api","modules/clean/auth/login/credentials_form","modules/clean/auth/login/sso_utils","modules/clean/auth/login/types","modules/clean/react/css","modules/core/i18n","modules/clean/react_format","modules/clean/profile_services/profile_services_constants","modules/clean/profile_services/profile_services_link","modules/clean/auth/authenticator"],function(e,t,o,r,s,a,i,n,c,l,p,u,m,h,d,g,S,_,T,y,F,f,w,E){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var C;(function(e){e[e.CREDENTIALS_OR_SSO=0]="CREDENTIALS_OR_SSO",e[e.PHONE_2FA=1]="PHONE_2FA",e[e.AUTHENTICATOR_2FA=2]="AUTHENTICATOR_2FA",e[e.SECKEY_2FA=3]="SECKEY_2FA"})(C||(C={})),t.TestOnlyLoginStep=C;var b=(function(e){function t(t){var r=e.call(this,t)||this;r.testOnlyGetSsoChecker=function(){return r.ssoChecker},r.setCredentialsFormComponent=function(e){r.credentialsFormComponent=e},r.testOnlyGetCredentialsFormComponent=function(){return r.credentialsFormComponent},r.onInputChange=function(e){var t=e.currentTarget,s={},a=o.__assign({},r.state.localErrors),i=!1;switch(t.name){case"login_email":s.email=t.value,a.email=void 0,i=!0;break;case"login_password":s.password=t.value,a.password=void 0;break;case"remember_me":s.rememberMe=t.checked;break;case"trusted":s.trusted=t.checked;break;case"code":s.twoFactorCode=t.value,a.twoFactor=void 0}s.localErrors=a,r.setState(s,function(){i&&r.ssoChecker.checkSsoState(s.email,r.onSsoStateUpdate)})},r.onSsoStateUpdate=function(e,t){e===r.state.email&&r.setState({ssoState:t})},r.onSsoChangeClick=function(){i.assert(r.state.ssoState===_.SsoState.OPTIONAL,"User can change SSO state only when it is optional",{tags:["react-login-form"]}),r.setState({ssoState:_.SsoState.OFF})},r.generateThirdPartyAuthUrl=function(e,t){var o={fname:e.profile.given_name,lname:e.profile.family_name,email:e.profile.email,picture_url:e.profile.picture_url,refresh_token:e.refresh_token,email_sig:e.email_sig,automatic_redirect:t.toString(),cont:r.props.continuationUrl||"/"};return r.props.googleLoginProps&&r.props.googleLoginProps.signupTag&&(o.signup_tag=r.props.googleLoginProps.signupTag),r.props.googleLoginProps&&r.props.googleLoginProps.signupEndpoint&&(o.signup_endpoint=r.props.googleLoginProps.signupEndpoint),String(new l.URI({path:"/third_party_signup"}).updateQuery(o))},r.handleGoogleCallback=function(e){if(e.success)r.handleLoginFormEvent(_.LoginFormEvent.GOOGLE_LOGIN_SUCCESS),c.Notify.success(y._("Log in successful! Your browser will be redirected in a few seconds.")),d.logProfileServicesSuccess(),a.redirect(r.props.continuationUrl||"/");else if(d.logProfileServicesFailure(),"emails_do_not_match_redirect"===e.err_msg){var t=r.generateThirdPartyAuthUrl(e,!0);a.redirect(t)}else if("emails_do_not_match"===e.err_msg)if("pairing"!==r.props.type&&r.props.variant===p.AuthFormVariant.STANDARD){var t=r.generateThirdPartyAuthUrl(e,!1),i=F.reactFormat(y._("Oops! We couldn’t find a Dropbox account matching that email. <a>Click here to create one.</a>"),{a:s.createElement("a",{className:"third-party-signup-link",href:t})});r.setState({localErrors:o.__assign({},r.state.localErrors,{googleLogin:i})})}else e.localized_error?c.Notify.error(e.localized_error):c.Notify.error(y._("There was a problem completing this request."));else if("tfa_required"===e.err_msg){var t=new l.URI({path:"/verify_code"}).updateQuery({cont:r.props.continuationUrl||"/",remember_me:e.remember_me.toString(),pair_user:e.pair_user.toString()});a.redirect(t.toString())}else if("not_verified"===e.err_msg){var t=new l.URI({path:"/show_password_form"}).updateQuery({cont:r.props.continuationUrl||"/",remember_me:e.remember_me.toString(),pair_user:e.pair_user.toString()});a.redirect(t.toString())}else e.localized_error?c.Notify.error(e.localized_error):c.Notify.error(y._("There was a problem completing this request.")),"google_login_not_allowed"!==e.err_msg&&"sso_required"!==e.err_msg||(r.setState({email:e.profile.email}),r.ssoChecker.checkSsoState(e.profile.email,r.onSsoStateUpdate))},r.onGoogleLoginClick=function(){r.handleLoginFormEvent(_.LoginFormEvent.GOOGLE_LOGIN_CLICK),r.setState({localErrors:{}});var e=!!r.props.googleLoginProps&&r.props.googleLoginProps.popup!==!1;(new w.ProfileServicesLinkingHandler).auth_service_login_web(f.GOOGLE,r.handleGoogleCallback,"login_form",e,r.state.rememberMe,r.props.continuationUrl||"/","pairing"===r.props.type)},r.credentialsFormData=function(){return o.__assign({login_email:r.state.email,login_password:r.state.password,cont:r.props.continuationUrl,remember_me:r.state.rememberMe},r.credentialsFormComponent.getRecaptchaResponses(),r.props.additionalData)},r.handleLoginSuccess=function(e){return r.handleLoginFormEvent(_.LoginFormEvent.LOGIN_IMMEDIATE_SUCCESS,{userInfo:e}),r.props.canRedirect!==!1?a.redirect(r.props.continuationUrl||"/"):r.props.onLoginSuccess?r.props.onLoginSuccess(e):a.redirect("/")},r.handleSuccessResponse=function(e){switch(e.status){case _.LoginResponseStatus.ERROR:var t=e.html_response?new n.HTML(e.message):e.message;return c.Notify.error(t);case _.LoginResponseStatus.EXPIRED:return a.redirect(e.cont);case _.LoginResponseStatus.OK:var s={id:e.id,email:e.email,display_name:e.display_name,locale:e.locale};r.handleLoginSuccess(s);break;case _.LoginResponseStatus.PASSWORD_EXPIRED:return r.setState({localErrors:o.__assign({},r.state.localErrors,{email:{message_text:y._("The password of the account associated with this email has expired.\n             Please login to this account and update its password before pairing.")}})});case _.LoginResponseStatus.RATELIMIT:return r.setState({localErrors:o.__assign({},r.state.localErrors,{email:{message_text:y._("You’ve tried to log in too many times. Please try again in a few minutes.")}})});case _.LoginResponseStatus.TWOFACTOR_REQUIRED:return a.redirect(e.cont);case _.LoginResponseStatus.TWOFACTOR:e.u2f_challenge&&E.canUseAuthenticator(r.generateU2fRequest(e.u2f_challenge))?(r.setState({primaryTwoFactorType:_.TwoFactorType.SEC_KEY,currentStep:C.SECKEY_2FA}),e.last_two_digits?r.setState({lastTwoDigits:e.last_two_digits,secondaryTwoFactorType:_.TwoFactorType.SMS}):r.setState({secondaryTwoFactorType:_.TwoFactorType.AUTHENTICATOR}),r.kickOffU2f(e.u2f_challenge)):e.last_two_digits?r.setState({primaryTwoFactorType:_.TwoFactorType.SMS,lastTwoDigits:e.last_two_digits,secondaryTwoFactorType:void 0,currentStep:C.PHONE_2FA}):r.setState({primaryTwoFactorType:_.TwoFactorType.AUTHENTICATOR,lastTwoDigits:void 0,secondaryTwoFactorType:void 0,currentStep:C.AUTHENTICATOR_2FA});break;case _.LoginResponseStatus.SSO:return a.unsafeRedirect(e.sso_url)}},r.handleServerErrors=function(e){var t={};e.login_email?t.email=e.login_email:t.email=void 0,e.login_password?t.password=e.login_password:t.password=void 0,e.recaptcha_response?t.captcha=e.recaptcha_response:e.recaptcha_response_v3?t.captcha=e.recaptcha_response_v3:t.captcha=void 0,e["failed-login-invalid-email-password"]?t.login=F.reactFormat(y._("Oops! It looks like you may have forgotten your password. <a>Click here to reset it.</a>"),{a:s.createElement("a",{href:"/forgot"})}):t.login=void 0,r.credentialsFormComponent.handleRecaptchaErrors(e),r.setState({localErrors:t})},r.onCredentialsFormSubmit=function(){r.setState({isSubmitting:!0});var e=d.submitCredentialsForm(r.props.type,r.credentialsFormData());e.catch(r.handleServerErrors),e.then(r.handleSuccessResponse),e.finally(function(){return r.setState({isSubmitting:!1})})},r.onLoginClick=function(e){e.preventDefault(),r.handleLoginFormEvent(_.LoginFormEvent.LOGIN_CLICK),r.credentialsFormComponent.submitRecaptcha()},r.handleResendCodeSuccess=function(e){var t;switch(e){case _.TwoFactorResendResponse.OK:return c.Notify.success(y._("We sent you a code. It may take a few minutes to arrive."));case _.TwoFactorResendResponse.RATELIMIT:t=y._("You’ve tried to log in too many times. Please try again in a few minutes.");break;case _.TwoFactorResendResponse.UNREACHABLE:t=y._("We couldn’t reach your phone number. Are you sure it’s correct?");break;case _.TwoFactorResendResponse.EXPIRED:t=y._("Sorry, your phone code has expired. Please log in again.");break;case _.TwoFactorResendResponse.BADCARRIER:t=y._("Unfortunately, your carrier isn’t supported at this time.");break;case _.TwoFactorResendResponse.INVALIDNUMBER:t=y._("That isn’t a valid phone number.");break;case _.TwoFactorResendResponse.NOTAMOBILE:t=y._("That phone number doesn’t appear to be a valid mobile number.");break;default:return c.Notify.error(y._("There was a problem completing this request."))}r.setState({localErrors:o.__assign({},r.state.localErrors,{twoFactor:{message_text:t}})})},r.resendCode=function(){var e=d.resendTwoFactorCode(r.props.additionalData&&r.props.additionalData.is_backup||!1,r.props.additionalData&&r.props.additionalData.mobile_push||!1);e.then(r.handleResendCodeSuccess),e.catch(function(){c.Notify.error(y._("There was a problem completing this request."))})},r.handleTwoFactorSuccess=function(e){switch(e.status){case _.LoginResponseStatus.OK:r.state.currentStep===C.SECKEY_2FA&&r.setState({securityKeyState:_.SecurityKeyState.FOUND});var t={id:e.id,email:e.email,display_name:e.display_name,locale:e.locale};r.handleLoginSuccess(t);break;case _.LoginResponseStatus.ERROR:c.Notify.error(e.message);break;case _.LoginResponseStatus.REQUIRES_ROLE:case _.LoginResponseStatus.EXPIRED:r.setState({localErrors:o.__assign({},r.state.localErrors,{email:{message_text:e.message}}),currentStep:C.CREDENTIALS_OR_SSO});break;default:c.Notify.error(y._("There was a problem completing this request."))}},r.twoFactorFormData=function(){return o.__assign({remember_me:r.state.rememberMe,cont:r.props.continuationUrl,code:r.state.twoFactorCode,trusted:r.state.trusted},r.props.additionalData)},r.submitTwoFactor=function(){r.setState({isSubmitting:!0});var e=d.submitTwoFactorForm(r.props.type,r.twoFactorFormData());e.then(r.handleTwoFactorSuccess),e.catch(function(e){r.state.currentStep===C.SECKEY_2FA&&e.u2f?r.setState({localErrors:o.__assign({},r.state.localErrors,{securityKey:e.u2f.message_text}),securityKeyState:_.SecurityKeyState.NOT_FOUND}):e.code?r.setState({localErrors:o.__assign({},r.state.localErrors,{twoFactor:e.code})}):c.Notify.error(y._("There was a problem completing this request."))}),e.finally(function(){r.setState({isSubmitting:!1})})},r.onPhone2FASubmit=function(e){e.preventDefault(),r.submitTwoFactor()},r.onAuthenticator2FASubmit=function(e){e.preventDefault(),r.submitTwoFactor()},r.generateU2fRequest=function(e){for(var t=JSON.parse(e),o={},r=0,s=Object.keys(E.PROTOCOLS);r<s.length;r++){var a=s[r];o[a]=t[a]&&JSON.parse(t[a])}return o},r.kickOffU2f=function(e){return o.__awaiter(r,void 0,void 0,function(){var t,r,s,a=this;return o.__generator(this,function(o){switch(o.label){case 0:if(t=this.generateU2fRequest(e),!E.canUseAuthenticator(t))return[3,5];o.label=1;case 1:return o.trys.push([1,3,,4]),[4,E.sign(t)];case 2:return r=o.sent(),this.state.currentStep===C.SECKEY_2FA&&this.setState({twoFactorCode:JSON.stringify(r)},function(){return a.submitTwoFactor()}),[3,4];case 3:return s=o.sent(),this.state.currentStep===C.SECKEY_2FA&&this.setState({securityKeyState:_.SecurityKeyState.NOT_FOUND}),i.assert(!1,"U2F Error - "+s,{tags:["react-login-form","u2f"]}),[3,4];case 4:return[3,5];case 5:return[2]}})})},r.switch2FA=function(){i.assert(r.state.primaryTwoFactorType===_.TwoFactorType.SEC_KEY,"Unexpected two factor choice switch",{tags:["react-login-form"]});var e;r.state.secondaryTwoFactorType===_.TwoFactorType.SMS?(e=C.PHONE_2FA,r.resendCode()):e=C.AUTHENTICATOR_2FA,r.setState({twoFactorCode:"",primaryTwoFactorType:r.state.secondaryTwoFactorType,secondaryTwoFactorType:void 0,currentStep:e})},r.onRetryU2f=function(){r.setState({securityKeyState:_.SecurityKeyState.LOADING});var e=d.retryU2fAuthentication();e.then(r.kickOffU2f),e.catch(function(){r.setState({securityKeyState:_.SecurityKeyState.NOT_FOUND}),c.Notify.error(y._("There was a problem completing this request."))})},i.assert(t.canRedirect!==!1||!!t.onLoginSuccess,"Need an on login success handler if we cannot redirect the user",{tags:["react-login-form"]}),r.ssoChecker=new S.SsoStateChecker;var u=C.CREDENTIALS_OR_SSO,m=void 0,h=void 0,g=void 0;return t.twoFactorOnlyProps&&(!t.twoFactorOnlyProps.u2fChallenge||t.additionalData&&t.additionalData.is_backup||!E.canUseAuthenticator(r.generateU2fRequest(t.twoFactorOnlyProps.u2fChallenge))?t.twoFactorOnlyProps.lastTwoDigits?(u=C.PHONE_2FA,m=_.TwoFactorType.SMS,g=t.twoFactorOnlyProps.lastTwoDigits):(u=C.AUTHENTICATOR_2FA,m=_.TwoFactorType.AUTHENTICATOR):(u=C.SECKEY_2FA,m=_.TwoFactorType.SEC_KEY,t.twoFactorOnlyProps.lastTwoDigits?(h=_.TwoFactorType.SMS,g=t.twoFactorOnlyProps.lastTwoDigits):h=_.TwoFactorType.AUTHENTICATOR)),r.state={currentStep:u,email:t.emailProps&&t.emailProps.initialValue||"",isSubmitting:!1,lastTwoDigits:g,localErrors:{},password:"",primaryTwoFactorType:m,secondaryTwoFactorType:h,rememberMe:t.rememberMeCheckboxProps&&t.rememberMeCheckboxProps.checked||!1,securityKeyState:_.SecurityKeyState.LOADING,ssoState:_.SsoState.OFF,trusted:t.twoFactorTrustCheckboxProps&&t.twoFactorTrustCheckboxProps.checked||!1,twoFactorCode:""},r}return o.__extends(t,e),t.prototype.handleLoginFormEvent=function(e,t){this.props.onLoginFormEvent&&this.props.onLoginFormEvent(e,t)},t.prototype.componentDidMount=function(){this.props.twoFactorOnlyProps&&this.props.twoFactorOnlyProps.u2fChallenge&&this.state.currentStep===C.SECKEY_2FA&&this.kickOffU2f(this.props.twoFactorOnlyProps.u2fChallenge)},t.prototype.render=function(){var e;switch(this.state.currentStep){case C.CREDENTIALS_OR_SSO:var t=!["multi","pairing","cli_link","cli_link_nonce"].includes(this.props.type);e=s.createElement(g.LoginCredentialsForm,{ref:this.setCredentialsFormComponent,disabled:this.props.disabled||!1,emailError:this.state.localErrors.email,emailProps:this.props.emailProps||{},emailValue:this.state.email,forgotPasswordProps:this.props.forgotPasswordProps||{},googleLoginError:this.state.localErrors.googleLogin,googleLoginProps:this.props.googleLoginProps,hideHelp:this.props.hideHelp||!1,hideRememberMe:this.props.hideRememberMe||!1,isSubmitting:this.state.isSubmitting,loginButtonProps:this.props.loginButtonProps||{},loginError:this.state.localErrors.login,maestroStyle:this.props.maestroStyle||!1,onGoogleLoginClick:this.onGoogleLoginClick,onInputChange:this.onInputChange,onLoginClick:this.onLoginClick,openLinksInNewTab:!!this.props.openLinksInNewTab,onSsoChangeClick:this.onSsoChangeClick,onSubmit:this.onCredentialsFormSubmit,passwordError:this.state.localErrors.password,passwordProps:this.props.passwordProps||{},passwordValue:this.state.password,recaptchaEndpoint:this.props.recaptchaEndpoint||"/needs_captcha",recaptchaError:this.state.localErrors.captcha,rememberMeProps:this.props.rememberMeCheckboxProps||{},rememberMeValue:this.state.rememberMe,showNaviSiteLogin:!!this.props.showNaviSiteLogin,ssoState:this.state.ssoState,supportsCaptcha:t,variant:this.props.variant||p.AuthFormVariant.STANDARD});break;case C.PHONE_2FA:e=s.createElement(m.Phone2FAForm,{continuationUrl:this.props.continuationUrl,error:this.state.localErrors.twoFactor,hideHelp:this.props.hideHelp||!1,hideTrustCheckbox:this.props.hideRememberMe||!1,inlineSubmit:void 0===this.props.twoFactorSubmitButtonInline||this.props.twoFactorSubmitButtonInline,lastTwoDigits:this.state.lastTwoDigits||"",maestroStyle:this.props.maestroStyle||!1,onInputChange:this.onInputChange,onResendCodeClick:this.resendCode,onSubmit:this.onPhone2FASubmit,rememberMe:this.state.rememberMe,trusted:this.state.trusted,trustTooltipPosition:this.props.twoFactorTrustCheckboxProps&&this.props.twoFactorTrustCheckboxProps.tooltipPosition,value:this.state.twoFactorCode,variant:this.props.variant||p.AuthFormVariant.STANDARD});break;case C.AUTHENTICATOR_2FA:e=s.createElement(u.Authenticator2FAForm,{continuationUrl:this.props.continuationUrl,error:this.state.localErrors.twoFactor,hideHelp:this.props.hideHelp||!1,hideTrustCheckbox:this.props.hideRememberMe||!1,inlineSubmit:void 0===this.props.twoFactorSubmitButtonInline||this.props.twoFactorSubmitButtonInline,maestroStyle:this.props.maestroStyle||!1,onInputChange:this.onInputChange,onSubmit:this.onAuthenticator2FASubmit,rememberMe:this.state.rememberMe,trusted:this.state.trusted,trustTooltipPosition:this.props.twoFactorTrustCheckboxProps&&this.props.twoFactorTrustCheckboxProps.tooltipPosition,value:this.state.twoFactorCode,variant:this.props.variant||p.AuthFormVariant.STANDARD});break;case C.SECKEY_2FA:e=s.createElement(h.SecKey2FAForm,{error:this.state.localErrors.securityKey,hideTrustCheckbox:this.props.hideRememberMe||!1,maestroStyle:this.props.maestroStyle||!1,onChange2FA:this.switch2FA,onInputChange:this.onInputChange,onRetry:this.onRetryU2f,trusted:this.state.trusted,trustTooltipPosition:this.props.twoFactorTrustCheckboxProps&&this.props.twoFactorTrustCheckboxProps.tooltipPosition,secondaryTwoFactorType:this.state.secondaryTwoFactorType,securityKeyState:this.state.securityKeyState,variant:this.props.variant||p.AuthFormVariant.STANDARD})}var o=r("login-form-container",this.props.variant,this.props.className);return s.createElement("div",{className:o},s.createElement("div",{className:"regular-login-forms"},e))},t})(s.Component);t.TestOnlyLoginFormComponent=b,t.LoginForm=T(b,["/static/css/components/exp_cards-vflJsYU3g.css","/static/css/components/login_form-vflEBYWs2.css","/static/css/legacy_packages/components-vflbDMbD3.css","/static/css/login_or_register-vfl9esD0O.css","/static/css/scooter/scooter-scoped-vflrM1SRf.css","/static/css/spectrum/index.web-vflBdlkSG.css","/static/css/recaptcha_challenge-vflrcf67y.css","/static/css/recaptcha_v2_challenge-vflYEW-GO.css"])});
//# sourceMappingURL=form.min.js-vflpNtVvQ.map